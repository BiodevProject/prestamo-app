<html xmlns:th="http://www.thymeleaf.org"
      th:replace="fragments/layout :: layout(~{::content}, '/css/facturaForm.css')"
      th:with="title='Registro'">
<div th:fragment="content">
  <!-- Main Content Container -->
  <div class="page-container" style="margin-top: 100px;">
    <!-- Breadcrumb -->

    <!-- Registration Panel -->
    <div class="info-panel">
      <header class="panel-header">
        <h1>Nueva Factura</h1>
        <div class="subheader">
          <nav class="breadcrumb" aria-label="breadcrumb">
            <a href="/">Inicio</a> ›
            <a href="/factura/dashboard">Facturas</a> ›
            <span class="current">Nueva factura</span>
          </nav>
          Complete el formulario para emitir una factura en el sistema
        </div>
      </header>

      <div class="info-section">
        <form th:action="@{/factura/save}" method="post">
          <div class="invoice-container horizontal-layout">
            <!-- Columnas laterales -->
            <div class="invoice-columns">
              <!-- Columna izquierda (Cliente) -->
              <div class="invoice-column client-column">
                <h2>Cliente</h2>
                <div class="invoice-field">
                  <label for="client-name">Nombre</label>
                  <input type="text" id="client-name" name="clientName" required
                         placeholder="Ej: Jose Luis" autocomplete="off">
                </div>
                <div class="invoice-field">
                  <label for="client-phone">Teléfono</label>
                  <input type="tel" id="client-phone" name="clientPhone"
                         placeholder="Ej: 5087070-7888" autocomplete="off">
                </div>
                <div class="invoice-field">
                  <label for="client-email">Email</label>
                  <input type="email" id="client-email" name="clientEmail"
                         placeholder="Ej: jose@test.com" autocomplete="off">
                </div>
              </div>

              <!-- Columna derecha (Vendedor) -->
              <div class="invoice-column seller-column">
                <h2>Vendedor</h2>
                <div class="invoice-field">
                  <label for="seller-name">Nombre</label>
                  <input type="text" id="seller-name" name="sellerName" required
                         placeholder="Ej: Obed Avarado" autocomplete="off">
                </div>
                <div class="invoice-field">
                  <label for="invoice-date">Fecha</label>
                  <input type="date" id="invoice-date" name="invoiceDate" required
                         autocomplete="off">
                </div>
                <div class="invoice-field">
                  <label for="payment-method">Método de Pago</label>
                  <select id="payment-method" name="paymentMethod">
                    <option value="Electro">Electro</option>
                    <option value="Efectivo">Efectivo</option>
                    <option value="Tarjeta">Tarjeta</option>
                    <option value="Transferencia">Transferencia</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Sección Productos (ancho completo) -->
            <div class="invoice-products">
              <h2>Productos/Servicios</h2>
              <table class="product-table">
                <thead>
                <tr>
                  <th>CÓDIGO</th>
                  <th>CANT.</th>
                  <th>DESCRIPCIÓN</th>
                  <th>PRECIO UNIT.</th>
                  <th>TOTAL</th>
                  <th>Acciones</th>
                </tr>
                </thead>
                <tbody id="product-list">
                <!-- Productos se añadirán aquí dinámicamente -->
                </tbody>
              </table>

              <div class="add-product horizontal-fields">
                <div class="invoice-field">
                  <label for="product-code">Código</label>
                  <input type="text" id="product-code" placeholder="Ej: ST01" autocomplete="off">
                </div>
                <div class="invoice-field">
                  <label for="product-quantity">Cantidad</label>
                  <input type="number" id="product-quantity" value="1" min="1" autocomplete="off">
                </div>
                <div class="invoice-field">
                  <label for="product-description">Descripción</label>
                  <input type="text" id="product-description" placeholder="Ej: Diseño de página web" autocomplete="off">
                </div>
                <div class="invoice-field">
                  <label for="product-price">Precio Unit.</label>
                  <input type="number" id="product-price" step="0.01" placeholder="Ej: 250.00" autocomplete="off">
                </div>
                <button type="button" class="btn btn-secondary" id="add-product">Agregar</button>
              </div>
            </div>

            <!-- Totales (alineados a la derecha) -->
            <div class="invoice-totals">
              <div class="total-row">
                <span>SUBTOTAL $</span>
                <span id="subtotal">0.00</span>
              </div>
              <div class="total-row">
                <span>IVA (13)% $</span>
                <span id="iva">0.00</span>
              </div>
              <div class="total-row grand-total">
                <span>TOTAL $</span>
                <span id="total">0.00</span>
              </div>
            </div>
          </div>

          <div class="panel-actions">
            <button type="submit" class="btn btn-primary">Emitir factura</button>
            <button type="button" class="btn btn-secondary" id="print-invoice">Imprimir</button>
            <a href="/factura/dashboard" class="btn btn-secondary">Cancelar</a>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Script para manejar la lógica de la factura (igual que antes) -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const addProductBtn = document.getElementById('add-product');
      const productList = document.getElementById('product-list');

      addProductBtn.addEventListener('click', function() {
        const code = document.getElementById('product-code').value;
        const quantity = document.getElementById('product-quantity').value;
        const description = document.getElementById('product-description').value;
        const price = document.getElementById('product-price').value;

        if (!code || !description || !price) {
          alert('Por favor complete todos los campos del producto');
          return;
        }

        const total = (quantity * price).toFixed(2);

        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${code}</td>
            <td>${quantity}</td>
            <td>${description}</td>
            <td>$${parseFloat(price).toFixed(2)}</td>
            <td>$${total}</td>
            <td><button type="button" class="btn-remove">Eliminar</button></td>
          `;

        productList.appendChild(row);

        // Limpiar campos
        document.getElementById('product-code').value = '';
        document.getElementById('product-quantity').value = '1';
        document.getElementById('product-description').value = '';
        document.getElementById('product-price').value = '';

        // Actualizar totales
        updateTotals();

        // Agregar evento para eliminar
        row.querySelector('.btn-remove').addEventListener('click', function() {
          row.remove();
          updateTotals();
        });
      });

      function updateTotals() {
        let subtotal = 0;
        const rows = productList.querySelectorAll('tr');

        rows.forEach(row => {
          const totalCell = row.cells[4].textContent;
          subtotal += parseFloat(totalCell.replace('$', ''));
        });

        const iva = subtotal * 0.13;
        const total = subtotal + iva;

        document.getElementById('subtotal').textContent = subtotal.toFixed(2);
        document.getElementById('iva').textContent = iva.toFixed(2);
        document.getElementById('total').textContent = total.toFixed(2);
      }

      // Botón de imprimir
      document.getElementById('print-invoice').addEventListener('click', function() {
        window.print();
      });
    });
  </script>
</div>
</html>